/*
 * Shorten, a jQuery plugin to automatically shorten text to fit in a block or a pre-set width and configure how the text ends.
 * Copyright (C) 2009-2011  Marc Diethelm
 * License: (GPL 3, http://www.gnu.org/licenses/gpl-3.0.txt) see license.txt
 */

(function(b){function t(h,c){return c.measureText(h).width}function u(h,c){c.text(h);return c.width()}var o=false,m;b.fn.shorten=function(){var h={},c=arguments,p=c.callee;if(c.length)if(c[0].constructor==Object)h=c[0];else if(c[0]=="options")return b(this).eq(0).data("shorten-options");else h={width:parseInt(c[0]),tail:c[1]};this.css("visibility","hidden");var i=b.extend({},p.defaults,h);return this.each(function(){var e=b(this),d=e.text(),n=d.length,j,a,f,g=b("<span/>").html(i.tail).text(),k={shortened:false, textOverflow:false};j=e.css("float")!="none"?i.width||e.width():i.width||e.parent().width();if(j<0)return true;e.data("shorten-options",i);this.style.display="block";this.style.whiteSpace="nowrap";if(m){a=b(this);f=document.createElement("canvas");l=f.getContext("2d");a.html(f);l.font=a.css("font-style")+" "+a.css("font-variant")+" "+a.css("font-weight")+" "+Math.ceil(parseFloat(a.css("font-size")))+"px "+a.css("font-family");a=l;f=t}else{a=b('<table style="padding:0; margin:0; border:none; font:inherit;width:auto;zoom:1;position:absolute;"><tr style="padding:0; margin:0; border:none; font:inherit;"><td style="padding:0; margin:0; border:none; font:inherit;white-space:nowrap;"></td></tr></table>'); $td=b("td",a);b(this).html(a);a=$td;f=u}var q=f.call(this,d,a);if(q<j){e.text(d);this.style.visibility="visible";e.data("shorten-info",k);return true}i.tooltip&&this.setAttribute("title",d);if(p._native&&!h.width){var r=b("<span>"+i.tail+"</span>").text();if(r.length==1&&r.charCodeAt(0)==8230){e.text(d);this.style.overflow="hidden";this.style[p._native]="ellipsis";this.style.visibility="visible";k.shortened=true;k.textOverflow="ellipsis";e.data("shorten-info",k);return true}}g=f.call(this,g,a);j-= g;g=j*1.15;if(q-g>0){g=d.substring(0,Math.ceil(n*(g/q)));if(f.call(this,g,a)>j){d=g;n=d.length}}do{n--;d=d.substring(0,n)}while(f.call(this,d,a)>=j);e.html(b.trim(b("<span/>").text(d).html())+i.tail);this.style.visibility="visible";k.shortened=true;e.data("shorten-info",k);return true})};var s=document.documentElement.style;if("textOverflow"in s)o="textOverflow";else if("OTextOverflow"in s)o="OTextOverflow";if(typeof Modernizr!="undefined"&&Modernizr.canvastext)m=Modernizr.canvastext;else{var l=document.createElement("canvas").getContext("2d"); m=l&&l.fillText?true:false;delete canvas}b.fn.shorten._is_canvasTextSupported=m;b.fn.shorten._native=o;b.fn.shorten.defaults={tail:"&hellip;",tooltip:true}})(jQuery);
